# EP001 - Default Extensions for Eta2017

# Motivation
[motivation]: #motivation

Eta uses some language extensions quite frequently, especially with respect to FFI. It
can be laborious to specify the same frequently used extensions over and over again.
Thus, we propose to define a set of language extensions that will be made default for 
Eta.

For example,

```haskell
  {-# LANGUAGE TypeFamilies, DataKinds, FlexibleContexts #-}

  foreign import java unsafe toString :: (a <: Object) => Java a String

  data {-# CLASS "java.io.File" #-} File = File (Object# File)
    deriving Class

  type instance Inherits File = '[Object]

  main :: IO ()
  main = do
    string <- java $ newFile "test.txt" >- toString
    putStrLn string
```

The extensions `TypeFamilies`, `DataKinds`, `FlexibleContexts`, are extremely common
in Eta FFI programs and so we would prefer them to be default.

Moreover, the language pragmas will seem extremely cumbersome for people coming from 
other languages because one has to remember which language change corresponds to which
extension which is cognitive overhead.

# Teachability
[teachability]: #teachability

It'll be easier to teach people not to add LANGUAGE pragmas over and over again.

# Summary
[summary]: #summary

We will define a set of extensions that will be default for the Eta language. This
will involve adding a new flag `-XEta2017` to the compiler that will turn on the
extensions by default. Etlas will also support `Eta2017` in the `default-language:` 
field and `etlas init` will generate `Eta2017` instead of `Haskell2010`.

The biggest concern here would be compatibility with Hackage, but we can assure that
there won't be any change there since all Hackage packages specify either `Haskell98` 
or `Haskell2010` in the `default-language:` field in their respective Cabal files and
the Eta compiler recognizes both. 

# Design
[design]: #design

We will list out all the extensions we wish to make default along with:

1. Brief description of what it does 
2. Why it should be default 
3. Consequences with respect to compilation time and usability of the language when
made default. 
  - NOTE: This may be omitted in some cases if the consequences are innocuous.
  
## List of Default Extensions
- [BangPatterns](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#bang-patterns-informal)
  - **Description**: Allows you to specify strictness.
  - **Rationale**: Conveys intent better in cases you want strictness. Also great for performance.
- [BinaryLiterals](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#binary-integer-literals)
  - **Description**: Allow literals like `0b1101` which corresponds to 13 in binary.
  - **Rationale**: Conveys intent better in some cases. Useful when dealing with bit fields.
  - **Consequences**
    - **Compilation**: It affects the speed of lexing by opening up a few more states, but very [minor impact](https://github.com/typelead/eta/blob/master/compiler/ETA/Parser/Lexer.x#L456-L492).
- [ConstrainedClassMethods](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#class-method-types)
  - **Description**: Allow additional constraints inside of class methods. 
  - **Rationale**: Quote the link above "The restriction is a pretty stupid one in the first place".
  - **Consequences**
    - **Compilation**: [Single usage](https://github.com/typelead/eta/blob/master/compiler/ETA/TypeCheck/TcTyClsDecls.hs#L1641)
- [ConstraintKinds](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#the-constraint-kind)
  - **Description**: A new kind for typeclass constraints called `Constraint` comes into scope that classifies the type constructors generated by typeclasses.
  - **Rationale**: Increases language power. Allows abstractions over constraints.
  - **Consequences**
    - **Compilation**: 
      - [Usage 1](https://github.com/typelead/eta/blob/master/compiler/ETA/TypeCheck/TcValidity.hs#L194)
      - [Usage 2](https://github.com/typelead/eta/blob/master/compiler/ETA/TypeCheck/TcValidity.hs#L539)
      - [Usage 3](https://github.com/typelead/eta/blob/master/compiler/ETA/TypeCheck/TcValidity.hs#L553)
- [DataKinds](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#datatype-promotion)
  - **Description**: Promotes datatypes to the type level allowing for user-defined kinds. 
  - **Rationale**: Increases language power. Facilitates type-level programming and makes way for lightweight dependent typing.
  - **Consequences**
    - **Compilation**: 
      - By default, whether or not `DataKinds` is turned on, the data structures representing promoted type constructors/data constructors are generated. Hence, turning on this extension by default will have no overall impact on memory usage/speed.
      - [Usage 1](https://github.com/typelead/eta/blob/master/compiler/ETA/TypeCheck/TcHsType.hs#L644)
      - [Usage 2](https://github.com/typelead/eta/blob/master/compiler/ETA/TypeCheck/TcHsType.hs#L1586)
      - Several other trivial usages in `ETA.Rename.RnTypes.rnHsTyKi`.
- [DefaultSignatures](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#default-method-signatures)
  - **Description**: Allows default implementations for typeclass methods for cases where the type implements one or more typeclasses.
  - **Rationale**: Facilitates generic programming and other use cases.
  - **Consequences**
    - **Compilation**: [Single Usage](https://github.com/typelead/eta/blob/master/compiler/ETA/Rename/RnBinds.hs#L845)
- [Deriving methods](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#deriving-instances-of-extra-classes-data-etc)
  - **Description**: Allows compiler generated instances for common typeclasses.
    - `DeriveDataTypeable` (`Data`, `Typeable`)
    - `DeriveGeneric` (`Generic`, `Generic1`)
    - `DeriveFoldable` (`Foldable`)
    - `DeriveFunctor` (`Functor`)
    - `DeriveTraversable` (`Traversable`)
  - **Rationale**: Saves time writing instances that can be systematically derived. 
  - **Consequences**: Allows new functionality by demand of the user.
- [DoAnIfThenElse](https://prime.haskell.org/wiki/DoAndIfThenElse)
  - **Description**: Allows use of `if .. then .. else ...` syntax without indentation of the `else`.
  - **Rationale**: Makes it easier for people transitioning from imperative languages.
  - **Consequences**: 
    - **Compilation**: [Single Usage](https://github.com/typelead/eta/blob/33a043f912baae11ef9dfd123a14db5fb395a328/compiler/ETA/Parser/RdrHsSyn.hs#L1155)
- [EmptyCase](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#empty-case-alternatives)
  - **Description**: Allows statements like `case x of {}`. It indicates the intent that the value is absurd (as in the case for functions that return `Void`). See the definition of the `Data.Void` in [base](https://github.com/typelead/eta/blob/master/libraries/base/Data/Void.hs).
  - **Rationale**: Conveys intent better in some cases.
  - **Consequences**
    - **Compilation**: [Single usage](https://github.com/typelead/eta/blob/master/compiler/ETA/Rename/RnBinds.hs#L988)
- [EmptyDataDecls](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#data-types-with-no-constructors)
  - **Description**: Allows data declarations with no data constructors.
  - **Rationale**: Conveys intent better in some cases and useful for phantom types.
  - **Consequences**
    - **Compilation**: [Single usage](https://github.com/typelead/eta/blob/33a043f912baae11ef9dfd123a14db5fb395a328/compiler/ETA/TypeCheck/TcTyClsDecls.hs#L1130)
- [ExistentialQuantification](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#existentially-quantified-data-constructors)
  - **Rationale**: Makes the language more powerful. Can help facilitate dependent types.
  - **Consequences**
    - **Compilation**: [Single usage](https://github.com/typelead/eta/blob/33a043f912baae11ef9dfd123a14db5fb395a328/compiler/ETA/TypeCheck/TcTyClsDecls.hs#L1462)
- [ExplicitForAll](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#explicit-universal-quantification-forall)
  - **Description**: Allows you to use the `forall` keyword in type signatures.
  - **Rationale**: Conveys programmer intent better. Makes code more clear.
  - **Consequences**
    - **Compilation**: Activates a couple extra checks in the parser.
- [ExplicitNamespaces](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#explicit-namespaces-in-import-export)
  - **Description**: Allows you to use the `type` keyword in export lists.
  - **Rationale**: Makes it clear whether a type or value is being exported.
  - **Consequences**
    - **Compilation**: Activates a couple extra checks in the parser.
- [FlexibleContexts](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#the-superclasses-of-a-class-declaration)
  - **Description**: Typically, constraints must only use type variables, but with this extension, the type variables can be instantiated to some concrete type. For example, `Extends a Object` is not valid without `FlexibleContexts`.
  - **Rationale**: `Extends` constraints are extremely common when binding to a Java Generics-based APIs.
  - **Consequences**
    - **Compilation**: [Single usage](https://github.com/typelead/eta/blob/master/compiler/ETA/TypeCheck/TcValidity.hs#L597).
    - *Potential Pitfall*: See this [SO post](http://stackoverflow.com/questions/18229572/what-are-the-pitfalls-of-using-flexiblecontexts-and-flexibleinstances). This can be overcome by making the typechecking of class method signatures more strict or produce awarning in the case mentioned.
- [FlexibleInstances](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#ghc-flag--XFlexibleInstances)
  - **Description**: Allow instance heads to be flexible (i.e. `Show (Maybe Integer)`) would be valid.
  - **Rationale**: Useful for type-level programming and simulating dependent types.
  - **Consequences**
    - **Compilation**: [Single usage](https://github.com/typelead/eta/blob/33a043f912baae11ef9dfd123a14db5fb395a328/compiler/ETA/TypeCheck/TcValidity.hs#L814).
- ForeignFunctionInterface
  - **Description**: Enables the `foreign` keyword.
- [FunctionalDependencies](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#functional-dependencies)
  - **Description**: Works with `MultiParameterTypeClasses`. Allows you to specify which 
  - **Rationale**: Useful for type-level programming and deterministic instance resolution.
  - **Consequences**
    - **Compilation**: [Single usage](https://github.com/typelead/eta/blob/33a043f912baae11ef9dfd123a14db5fb395a328/compiler/ETA/TypeCheck/TcTyClsDecls.hs#L1644).
- [GADT/GADTSyntax](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#generalised-algebraic-data-types-gadts)
  - **Rationale**: Adds power to the languages. Makes way for partial dependent types.
- [ImplicitPrelude](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#rebindable-syntax-and-the-implicit-prelude-import)
  - **Description**: Imports the `Prelude` module automatically. You can also [specify the prelude](https://github.com/typelead/eta/issues/308) to use by the `-prelude` flag to the compiler.
  - **Rationale**: Saves the user from having to retype `import Prelude` at the top of every file.
- [InstanceSigs](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#instance-signatures-type-signatures-in-instance-declarations)
  - **Description**: Allows you to specify type signatures in an instance declaration.
  - **Rationale**: Writing the type signature serves as a way to guide you to the implementation.
- [JavaFFI](https://github.com/typelead/eta/issues/84)
  - **Description**: Allows the `java` calling convention for types.
  NOTE: The pragma itself is yet to be implemented as mentioned in the linked issue.
- [KindSignatures](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#explicitly-kinded-quantification)
  - **Description**: Allows you to annotate types with kind in type declarations.
  - **Rationale**: Improves readability and essential for dependent types.
- [LambdaCase](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#lambda-case)
  - **Description**: Allows you to directly pattern match on the argument of an anonymous function (lambda).
  - **Rationale**: Improves readability and makes higher order functions easier to use.
- [LiberalTypeSynonyms](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#liberalised-type-synonyms)
  - **Description**: Allows you to define more classes of type synonyms - the typechecking is deferred until after substitution.
  - **Rationale**: Allow you to do more abstraction at the type-level.
- [MagicHash](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#the-magic-hash)
  - **Description**: Allows you to work with primitive literals and use # as part of identifier names.
  - **Rationale**: It's used very frequently by the Eta FFI when using `Object#` and the errors are cryptic if you forget to turn this extension on.
- [MonoLocalBinds](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#let-generalisation)
  - **Description**: Does not generalize the inferred types for `let` bindings.
  - **Rationale**: Needed for predictable type inference involving type families and GADTs.
- [MultiParamTypeClasses](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#multi-parameter-type-classes)
  - **Description**: Allows you to specify multiple parameters for a type class.
  - **Rationale**: Increases language power and is the foundation of the frequently used `Extends` typeclass.
- [MultiWayIf](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#multi-way-if-expressions)
  - **Description**: Allows you write a chain of `if` statements using the `PatternGuards` style.
  - **Rationale**: Allows you to express certain programs more succinctly and cleanly.
- [NamedFieldPuns](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#record-puns)
  - **Description**: Allows you to write `C { a }` in place of `C { a = a }`.
  - **Rationale**: Makes it easier to deal with records.
- [NamedWildCards](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#named-wildcards)
  - **Description**: Allows you to name type holes.
  - **Rationale**: Conveys the intent of a type hole and adds more power by allowing you to force two holes to be the same type.
- [NegativeLiterals](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#negative-literals)
  - **Description**: Handle negative literals better.
  - **Rationale**: You can get some really unexpected errors in some cases. Makes it easier on the user.
- [NumDecimals](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#fractional-looking-integer-literals)
  - **Description**: Allows floating point notation to be parsed as integral types.
  - **Rationale**: Useful for defining large constants with floating point notation.
- [OverloadedStrings](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#overloaded-string-literals)
  - **Description**: Allows overloading of string literals.
  - **Rationale**: Useful for defining large constants with floating point notation.
  - **Consequences**: 
    - Eta has `JString` in addition to `String` so it cumbersome for the user to constantly do conversions themselves.
    - This might make type inference a bit more difficult in cases where you send string literals to polymorphic functions, but we can address that with custom default rules.
- [PackageImports](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#package-qualified-imports)
  - **Description**: Allows specifying a package identifier to uniquely identify duplicate module names. 
  - **Rationale**: Useful for handling some edge cases.
- [ParallelListComp](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#parallel-list-comprehensions) 
  - **Description**: Allows traversing two or more lists in parallel, similar to the behavior of `zip`.
  - **Rationale**: Useful for expressing traversals that involve `zip` without resorting to ordered pairs.
- [PatternGuards](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#pattern-guards)
  - **Description**: Allows you to write guards that succeed only on successful pattern matches. 
  - **Rationale**: Can make code much more readable and concise, avoiding the clumsy `case` syntax when typically only one pattern is of concern.
- [PolyKinds](https://downloads.haskell.org/~ghc/7.10.3/docs/html/users_guide/kind-polymorphism.html)
  - **Description**: This will generalize kinds when declaring data types and makes the kind inference stronger.
  - **Rationale**: Facilitates dependently-typed programming techniques.
- [RankNTypes](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#arbitrary-rank-polymorphism)
  - **Description**: This will allow you to declare higher-order functions that require polymorphic functions as arguments.
  - **Rationale**: Adds power to the type system and allows use cases like the `ST` monad.
- [RebindableSyntax](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#rebindable-syntax-and-the-implicit-prelude-import)
  - **Description**: Allows you to override the meaning of various basic syntactic constructs.
  - **Rationale**: Very useful for DSLs that want to overloaded common syntactic constructs like `do`-notation. 
- [RecordWildCards](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#record-wildcards)
  - **Description**: Allows you to bring all record accessors into scope, bound to the corresponding values.
  - **Rationale**: Makes handling the clumsy records more pleasant. 
- [RecursiveDo](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#the-recursive-do-notation)
  - **Description**: Allows recursive use of the monadic bind. Relies on `MonadFix` typeclass.
  - **Rationale**: Adds more power to `do`-notation and concisely expressions some use cases.
- [RelaxedPolyRec](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#generalised-typing-of-mutually-recursive-bindings)
  - **Description**: Generalizes types for mutually recursive bindings. 
  - **Rationale**: Enabled by default regardless of turning on/off.
- [ScopedTypeVariables](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#lexically-scoped-type-variables)
  - **Description**: Brings type variables bound by `forall` into scope in the entire function. 
  - **Rationale**: Useful for some dependently typed applications such as `singletons`.
- [StandaloneDeriving](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#stand-alone-deriving-declarations)
  - **Description**: Makes the `deriving` syntax more flexible - it can be used outside of the original data declaration.
  - **Rationale**: Allows more flexibility for the user for the otherwise rigid `deriving` clause.
- [TraditionalRecordSyntax](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#traditional-record-syntax)
  - **Description**: Allows record notation for setting fields.
  - **Rationale**: It makes working with data types easier.
- [TypeFamilies](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#type-families)
  - **Description**: Allows you to write type-level functions as well as associated types for typeclasses.
  - **Rationale**: Adds type system power and facilitates dependently-typed applications.
- [TypeOperators](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#type-operators)
  - **Description**: Allows you to declare types with symbol names.
  - **Rationale**: Required for using `<:`, which is common in Eta. Allows for more readable types.
- [TypeSynonymInstances](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#relaxed-rules-for-the-instance-head)
  - **Description**: Allows you to declare instances for fully-applied type synonyms.
  - **Rationale**: Can make the code more reasonable in some cases. Turned on by default if `FlexibleContexts` is.
- [UnboxedTuples](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#ghc-flag--XUnboxedTuples)
  - **Description**: Allows you to return multiple values in an unboxed fashion.
  - **Rationale**: Can be used for efficiency. Using unboxed tuples without the extension turned on also yields strange type errors.
- *UnliftedFFITypes*
  - **Description**: Allows you to specify primitive, unlifted types (like `Int#`) in FFI declarations.
  - **Rationale**: Can be used for efficiency by avoiding boxed in FFI calls.

To be explicit, the following extensions are turned off by default:
- [MonomorphismRestriction](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#switching-off-the-dreaded-monomorphism-restriction) - Causes weird type errors for beginners, so it was switched off in GHCi 7.8.1.

Note that extensions not mentioned in this list **can still be used** as long as the appropriate `LANGUAGE` pragma is turned on.

# Unresolved
[unresolved]: #unresolved

We are unsure whether to add the following extensions as default. Please let us know what you think.
- [RoleAnnotations](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#role-annotations)/[GeneralizedNewtypeDeriving](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#generalised-derived-instances-for-newtypes)
  - Widely considered an unsafe feature and role annotations were made as a solution. But is the solution sufficient? See [GHC Trac #8745](https://ghc.haskell.org/trac/ghc/ticket/8745) and [this Reddit post](https://www.reddit.com/r/haskell/comments/y8kca/generalizednewtypederiving_is_very_very_unsafe/).
- [Postfix Operators](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#postfix-operators) - This just seems like it'll make things more confusing than they are.
- [MonadComprehensions](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#monad-comprehensions)/[TransformListComp](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#generalised-sql-like-list-comprehensions) - For those familiar with C#, the combination of all of those is LINQ. The main reason against making these default is that existing list comprehensions might have ambiguous types. The [proposed resolution](https://www.google.co.in/?gfe_rd=cr&ei=kxQIWcxh54rxB8iLitAJ#q=bringing+back+monad+comprehensions) is to add a defaulting rule for the `Monad` typeclass.
- [View Patterns](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#view-patterns) - Seems to make code more confusing. One can just use `PatternGuards` as a substitute which are much more readable.
- [PatternSynonyms](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html#pattern-synonyms) - Recently added feature that's quite useful, but it is experimental and may be deferred for future versions of Eta.
